---
title: "Monkeypox World Dashboard"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: rows
    vertical_layout: scroll
  runtime: shiny
resource_files:
- countries sf/World_Countries__Generalized_.shp
- countries sf/World_Countries_(Generalized).xml
- countries sf/World_Countries__Generalized_.cpg
- countries sf/World_Countries__Generalized_.dbf
- countries sf/World_Countries__Generalized_.prj
- countries sf/World_Countries__Generalized_.shx
- "us-states-sf/cb_2021_us_state_500k.cpg"
- "us-states-sf/cb_2021_us_state_500k.dbf"
- "us-states-sf/cb_2021_us_state_500k.prj"
- "us-states-sf/cb_2021_us_state_500k.shp.ea.iso.xml"
- "us-states-sf/cb_2021_us_state_500k.shp.iso.xml"
- "us-states-sf/cb_2021_us_state_500k.shx"
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
library(plotly)
library(tmap)
library(sf)
library(leaflet)
library(rsconnect)
library(shiny)

mpx_country_case_dat_v2 <- read_csv("exported data/mpx_country_case_dat_v2.csv")
mpx_gbl_hospitalizations <- read_csv("exported data/mpx_gbl_hospitalizations.csv")
```



```{r map processing, include=FALSE}
# import shapefile
world_shp <- sf::st_read("countries sf/World_Countries__Generalized_.shp")

# sort country case date to latest 
mpx_global_latest <- mpx_country_case_dat_v2 %>%
  group_by(Country)%>%
  filter(Date_confirmation == max(Date_confirmation), Country != "World")%>%
  select(Country, Date_confirmation, cumulative_confirmed, cumulative_confirmed_suspected, cumulative_confirmed_per_1M, cumulative_confirmed_suspected_per_1M)

mpx_global_map <- merge(world_shp,
                        mpx_global_latest,
                        by.x = "COUNTRY", 
                        by.y = "Country", 
                        all = FALSE)


```
World Data
===========================================================================================

```{r value boxes, include=FALSE}
mpx_world <- mpx_country_case_dat_v2 %>%
  filter(Date_confirmation == max(Date_confirmation), Country == "World")
today_cumulative_confirmed = mpx_world$cumulative_confirmed[1]
today_cumulative_suspected = mpx_world$cumulative_suspected[1]
today_cumulative_confirmed_suspected = mpx_world$cumulative_confirmed_suspected[1]

```

World data pulled from [Global.health](https://github.com/globaldothealth/monkeypox) `r Sys.Date()`.  
Note that all map data and aggregated cumulative count data (including the widgets to the right) are based on data on the last recorded date in each country. For these dates, please refer to the World Data Table towards the bottom of the page.  


Row 
---------------------------------------------------------------------------------------------


### Cumulative Confirmed Cases
```{r}
valueBox(today_cumulative_confirmed)
```

### Cumulative Suspected Cases
```{r}
valueBox(today_cumulative_suspected)
```

### Cumulative Confirmed and Suspected Cases
```{r}
valueBox(today_cumulative_confirmed_suspected)
```


Row 
-----------------------------------------------------------------------

### World Map
```{r}
shinyApp(
  ui = fluidPage(
    selectInput("world_choice", "Choose a map to display:", choices = c ("Cumulative Confirmed Cases", "Cumulative Confirmed and Suspected Cases", "Cumulative Confirmed Cases per Million", "Cumulative Confirmed and Suspected Cases per Million"), selected = "Cumulative Confirmed Cases"), 
    tmapOutput("user_world_map")
      
      
  ),
  
  
  server = function(input, output) {
    output$user_world_map<- renderTmap({
        if(input$world_choice == "Cumulative Confirmed Cases"){
          tmap_mode("view")
          tm_shape(mpx_global_map)+
            tm_polygons(col = "cumulative_confirmed")
        } else if(input$world_choice == "Cumulative Confirmed and Suspected Cases"){
          tmap_mode("view")
tm_shape(mpx_global_map)+
  tm_polygons(col = "cumulative_confirmed_suspected")
        } else if(input$world_choice == "Cumulative Confirmed and Suspected Cases"){
          tmap_mode("view")
tm_shape(mpx_global_map)+
  tm_polygons(col = "cumulative_confirmed_per_1M")
        }else{
          tmap_mode("view")
tm_shape(mpx_global_map)+
  tm_polygons(col = "cumulative_confirmed_suspected_per_1M")
        }
    })
  },
  options = list(height = 600)
)


```

Row {.tabset}
-----------------------------------------------------------------------

```{r filter all world data timeseries, include=FALSE}
mpx_world_ts <- mpx_country_case_dat_v2 %>%
  filter(Country == "World")
```


### Cumulative Case Trend
```{r}
plot_ly(mpx_world_ts, x = ~Date_confirmation, y = ~cumulative_confirmed, type = "scatter", mode = "lines", name = 'Cumulative Confirmed') %>%
  add_trace(y = ~cumulative_suspected, mode = 'lines', name = 'Cumulative Suspected')%>%
  add_trace(y = ~cumulative_confirmed_suspected, mode = "lines", name = "Cummulative Confirmed and Suspected")%>%
  layout(xaxis = list(title = "Date"), yaxis = list(title = "Cumulative Count"))
```

### World Daily Trend

```{r}
plot_ly(mpx_world_ts, x = ~Date_confirmation, y = ~confirmed, type = 'bar', name = 'Confirmed')%>%
  add_trace(y = ~suspected, name = 'Suspected')%>%
  layout(xaxis = list(title = 'Date'), yaxis = list(title = 'Daily Count'), barmode = 'stack')%>%
  add_trace(y = ~daily_confirmed_suspected_07d, type = "scatter", mode = 'lines', name = "7-day Rolling Average: Confirmed + Suspected")%>%
  add_trace(y = ~daily_confirmed_07d, type = "scatter", mode = 'lines', name = "7-day Rolling Average: Confirmed, only")
```


Row 
-------------------------------
### World Data Table
```{r, include = FALSE}
# filter & arrange by highest cumulative cases 
mpx_dt <- mpx_global_latest %>%
  arrange(-cumulative_confirmed)

```

```{r display table}
knitr::kable(mpx_dt, digits = 2, col.names = c("Country", "Date Last Recorded", "Cumulative Confirmed", "Cumulative Confirmed and Suspected", "Cumulative Confirmed per Million", "Cumulative Confirmed and Suspected per Million"))

```


United States
===========================================================================================
```{r us-setup, include=FALSE}
# map state trends, get state map
mpx_us_state_case_dat <- read_csv("exported data/mpx_us_state_case_dat.csv") %>%
  arrange(state, Date_confirmation)
us_state_shp <- st_read("us-states-sf/cb_2021_us_state_500k.shp")

# # select states to map - state daily, state cumulatives --> drop down menu 
us_mpx_map <- merge(us_state_shp,
                    mpx_us_state_case_dat,
                    by.x = "NAME",
                    by.y = "state",
                    all = FALSE)

us_latest_map <- us_mpx_map %>%
  group_by(NAME)%>%
  filter(Date_confirmation == max(Date_confirmation))


# us_mpx_time_series <- mpx_us_state_case_dat %>%
#   drop_na()
#   
  
```

Row {.tabset}
----------------------------------------------------------------------------------
### Cumulative Counts
```{r}
tmap_mode("view")
tm_shape(us_latest_map)+
  tm_polygons(col = "cumulative_confirmed")

```

### Cumulative per Million
```{r}
tmap_mode("view")
tm_shape(us_latest_map)+
  tm_polygons(col = "cumulative_confirmed_per_1M", breaks = c(0,5,10,20,30, Inf))

```


Row {data-height = 1000}
-------------------------------------------------------------------
```{r}
  ui = fillPage(
      selectInput("choice", "State", choices = unique(mpx_us_state_case_dat$state)), 
    plotlyOutput("ts_daily"),
    plotlyOutput("state_cumulative")
      
      
  )
  server1 = function(input, output) {
    output$ts_daily<-renderPlotly({
        state_tbl <- mpx_us_state_case_dat %>%
          filter(state == as.character(input$choice)) %>%
          arrange(Date_confirmation)
    
    plot_ly(state_tbl,x = ~Date_confirmation, y = ~confirmed, type = "bar", name = "Count") %>%
    add_trace(y = ~state_07d, type = "scatter", mode = "lines", name = "7 day rolling average")
      
    })
    
    output$state_cumulative <- renderPlotly({
      state_tbl <- mpx_us_state_case_dat %>%
          filter(state == as.character(input$choice)) %>%
          arrange(Date_confirmation)
      
      plot_ly(state_tbl, x = ~Date_confirmation, y = ~cumulative_confirmed, type = "scatter", mode = "lines", name = "State Cumulative")
    })
  }

shinyApp(ui, server1, options = list(height = 2000))
```


Row {.tabset}
-------------------------------------------
### Cumulative Confirmed
```{r}
plot_ly(mpx_us_state_case_dat, x = ~Date_confirmation, y = ~cumulative_confirmed, type = "scatter", mode = "lines", color = ~state)
```

### Cumulative Confirmed per Million
```{r}
plot_ly(mpx_us_state_case_dat, x = ~Date_confirmation, y = ~cumulative_confirmed_per_1M, type = "scatter", mode = "lines", color = ~state)
```

Row
-----------------------------------------
### State Cumulatives 
```{r sort us table, include= FALSE}
mpx_us_latest_tbl <- mpx_us_state_case_dat[, c("state", "Date_confirmation", "cumulative_confirmed", "cumulative_confirmed_per_1M")] %>%
  group_by(state) %>%
  filter(Date_confirmation == max(Date_confirmation))
```

```{r}
knitr::kable(mpx_us_latest_tbl, digits = 2, col.names = c("State", "Date Last Recorded", "Cumulative Confirmed", "Cumulative Confirmed per Million"))

```
Country 
=============================================================================
Row 
-------------------------------------------------------
### Country Time Series 
```{r country time series} 
inputs <- selectInput("country_choice", "Country", choices = unique(mpx_country_case_dat_v2$Country)) 
 ui_country = fluidPage(
      inputs, 
    plotlyOutput("country_ts"),
    plotlyOutput("country_cumulative")
  )

server_country= function(input, output) {
    output$country_ts<-renderPlotly({
        country_tbl <- mpx_country_case_dat_v2 %>%
          filter(Country == as.character(input$country_choice)) %>%
          arrange(Date_confirmation)
    
    plot_ly(country_tbl, x = ~Date_confirmation, y = ~confirmed, type = 'bar', name = 'Confirmed')%>%
  add_trace(y = ~suspected, name = 'Suspected')%>%
  layout(xaxis = list(title = 'Date'), yaxis = list(title = 'Daily Count'), barmode = 'stack')
      
    })
    
    output$country_cumulative <- renderPlotly({
      country_tbl <- mpx_country_case_dat_v2 %>%
          filter(Country == as.character(input$country_choice)) %>%
          arrange(Date_confirmation)
      plot_ly(country_tbl, x = ~Date_confirmation, y = ~cumulative_confirmed, type = "scatter", mode = "lines", name = 'Cumulative Confirmed') %>%
  add_trace(y = ~cumulative_suspected, mode = 'lines', name = 'Cumulative Suspected')%>%
  add_trace(y = ~cumulative_confirmed_suspected, mode = "lines", name = "Cummulative Confirmed and Suspected")%>%
  layout(xaxis = list(title = "Date"), yaxis = list(title = "Cumulative Count"))
      
    })
    
  }

shinyApp(ui_country, server_country, options = list(height = 1000))
```

Row {.tabset}
------------------
### Country Cumulative Confirmed and Suspected 
```{r}
plot_ly(filter(mpx_country_case_dat_v2, Country != 'World'), x = ~Date_confirmation, y = ~cumulative_confirmed_suspected, type = "scatter", mode = "lines", color = ~Country)
```

### Country Cumulative Confirmed
```{r}
plot_ly(filter(mpx_country_case_dat_v2, Country != 'World'), x = ~Date_confirmation, y = ~cumulative_confirmed, type = "scatter", mode = "lines", color = ~Country)
```

### Country Cumulative Confirmed and Suspected per Million
```{r}
plot_ly(filter(mpx_country_case_dat_v2, Country != 'World'), x = ~Date_confirmation, y = ~cumulative_confirmed_suspected_per_1M, type = "scatter", mode = "lines", color = ~Country)
```

### Country Cumulative Confirmed per Million
```{r}
plot_ly(filter(mpx_country_case_dat_v2, Country != 'World'), x = ~Date_confirmation, y = ~cumulative_confirmed_per_1M, type = "scatter", mode = "lines", color = ~Country)
```


About
======================================================================================
#### Site Maintenance 
  This site aims to be updated daily. However, sometimes there will be lags (i.e. site owner not available). I am trying to figure out how to automate updating the site. There may also be lags in time (i.e. Site updated on 7/16/2021 may not yet contain 7/16/2021 data). Additionally, each country may update their data at various times. 
  
#### Data Sources
- Confirmed and Suspected Cases (Global and U.S.): [Global.health](https://github.com/globaldothealth/monkeypox)
- World Countries Shapefile: [ArcGis Hub](https://hub.arcgis.com/datasets/esri::world-countries-generalized/about)
- World Population Counts: [World Population Review](https://worldpopulationreview.com/countries)
- U.S. Cities and County Crosswalk: [https://simplemaps.com/data/us-cities](https://simplemaps.com/data/us-cities)

#### About Me
  Cindy Pang currently maintains this site. She is a fourth-year bachelors student studying Biostatistics and Mathematics at the University of North Carolina at Chapel Hill. She also works at the [Carolina Population Center](https://www.cpc.unc.edu/) as an Undergraduate Research Assistant in the Delamater Lab where her work has focused on modeling the impact of disease and vaccination-induced herd immunity on SARS-CoV-2 infections across counties in the state of North Carolina, U.S.A. Cindy's broader research interests are in Spatial Epidemiology and Causal Inference for Infectious Diseases. 
  
#### Contact 
Email: [pangcind@live.unc.edu](pangcind@live.unc.edu)
